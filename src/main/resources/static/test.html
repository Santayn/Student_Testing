<!-- src/main/resources/static/test.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Прохождение теста</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
    <div id="err" class="alert alert-danger d-none"></div>

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h1 id="testTitle" class="h5 mb-0">Загрузка…</h1>
            <span id="badge" class="badge text-bg-secondary d-none">ID</span>
        </div>
        <div id="testBody" class="card-body">Загрузка…</div>
        <div class="card-footer d-flex gap-2">
            <a id="back" class="btn btn-outline-secondary" href="javascript:history.back()">Назад</a>
            <button id="submitBtn" class="btn btn-primary">Отправить</button>
        </div>
    </div>

    <div id="result" class="mt-3 d-none"></div>
</div>

<script>
    (function () {
      const q = new URL(location.href).searchParams;
      const testId = q.get('testId');
      const err = document.getElementById('err');
      const body = document.getElementById('testBody');
      const title = document.getElementById('testTitle');
      const badge = document.getElementById('badge');
      const submitBtn = document.getElementById('submitBtn');
      const resultBox = document.getElementById('result');

      let questions = [];

      if (!testId) {
        err.textContent = 'Не передан testId';
        err.classList.remove('d-none');
        return;
      }

      function safe(text){ const d=document.createElement('div'); d.textContent=text||''; return d.innerHTML; }

      async function load() {
        const res = await fetch(`/api/v1/public/tests/${encodeURIComponent(testId)}`, {credentials:'same-origin'});
        if (!res.ok) throw new Error(`Не удалось загрузить тест (${res.status})`);
        const data = await res.json();

        title.textContent = data.test.description || `Тест #${data.test.id}`;
        badge.classList.remove('d-none');
        badge.textContent = `ID: ${data.test.id}`;
        questions = data.questions || [];

        if (!questions.length) {
          body.innerHTML = '<div class="text-muted">Нет вопросов.</div>';
          submitBtn.disabled = true;
          return;
        }

        const form = document.createElement('div');
        questions.forEach((q, idx) => {
          const block = document.createElement('div');
          block.className = 'mb-3';
          block.innerHTML = `
            <label class="form-label fw-semibold">Вопрос ${idx+1}</label>
            <div class="mb-2">${safe(q.text)}</div>
            <input class="form-control" data-qid="${q.id}" placeholder="Ваш ответ">
          `;
          form.appendChild(block);
        });
        body.innerHTML = '';
        body.appendChild(form);
      }

      async function submit() {
        const inputs = body.querySelectorAll('input[data-qid]');
        const questionIds = [];
        const answers = [];
        inputs.forEach(inp => {
          questionIds.push(Number(inp.dataset.qid));
          answers.push(inp.value || '');
        });

        const res = await fetch(`/api/v1/public/tests/${encodeURIComponent(testId)}/submit`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({questionIds, answers})
        });

        if (res.status === 401) {
          err.textContent = 'Нужно войти как студент, чтобы отправить ответы.';
          err.classList.remove('d-none');
          return;
        }
        if (!res.ok) {
          err.textContent = `Не удалось отправить ответы (${res.status})`;
          err.classList.remove('d-none');
          return;
        }

        const r = await res.json();
        resultBox.className = 'mt-3';
        resultBox.innerHTML = `
          <div class="alert alert-info">
            Результат: <strong>${r.correctCount}</strong> из <strong>${r.totalCount}</strong>
          </div>
          <div class="card">
            <div class="card-header">Детали</div>
            <ul class="list-group list-group-flush">
              ${r.details.map(d => `
                <li class="list-group-item">
                  <div class="fw-semibold">${safe(d.questionText)}</div>
                  <div class="small">Ваш ответ: ${safe(d.givenAnswer || '—')}</div>
                  <div class="small">Правильный: ${safe(d.correctAnswer)}</div>
                  <span class="badge ${d.correct ? 'text-bg-success' : 'text-bg-danger'}">
                    ${d.correct ? 'Верно' : 'Неверно'}
                  </span>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
        window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
      }

      (async function boot(){
        try { await load(); }
        catch(e){ err.textContent = e.message || 'Ошибка загрузки'; err.classList.remove('d-none'); }
      })();

      submitBtn.addEventListener('click', () => submit().catch(e=>{
        err.textContent = e.message || 'Ошибка отправки'; err.classList.remove('d-none');
      }));
    })();
</script>
</body>
</html>
