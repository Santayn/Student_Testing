<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Детали лекции</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/kubstuTest">Главная</a></li>
            <li class="breadcrumb-item"><a id="crumbSubjects" href="/subjects.html">Предметы</a></li>
            <li class="breadcrumb-item"><a id="crumbLectures" href="#">Лекции</a></li>
            <li class="breadcrumb-item active" aria-current="page"><span id="crumbCurrent">Детали лекции</span></li>
        </ol>
    </nav>

    <div id="err" class="alert alert-danger d-none" role="alert"></div>

    <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h1 id="title" class="h4 mb-0">Загрузка…</h1>
            <span id="badgeId" class="badge text-bg-secondary d-none">ID: —</span>
        </div>
        <div class="card-body">
            <p class="mb-2"><strong>Описание:</strong></p>
            <div id="description" class="mb-3 text-muted">—</div>

            <p class="mb-2"><strong>Содержание:</strong></p>
            <div id="content" class="border rounded p-3 bg-white">—</div>
        </div>
        <div class="card-footer d-flex gap-2">
            <a id="back" class="btn btn-outline-secondary" href="#">Назад к лекциям</a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header"><h2 class="h5 mb-0">Доступные тесты</h2></div>
        <div class="card-body" id="testsBox">Загрузка…</div>
    </div>
</div>

<script>
    (function () {
      const url = new URL(location.href);
      const subjectId = url.searchParams.get('subjectId');
      const lectureId = url.searchParams.get('lectureId');

      const errBox  = document.getElementById('err');
      const titleEl = document.getElementById('title');
      const descEl  = document.getElementById('description');
      const contentEl = document.getElementById('content');
      const badgeId = document.getElementById('badgeId');
      const back    = document.getElementById('back');
      const testsBox= document.getElementById('testsBox');

      const crumbLectures = document.getElementById('crumbLectures');
      const crumbSubjects = document.getElementById('crumbSubjects');

      if (!subjectId || !lectureId) {
        errBox.textContent = 'Нужны параметры subjectId и lectureId';
        errBox.classList.remove('d-none');
        return;
      }

      back.href = `/lectures.html?subjectId=${encodeURIComponent(subjectId)}`;
      crumbLectures.href = back.href;

      function safeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
      }

      async function loadLecture() {
        const res = await fetch(`/api/v1/public/lectures/${encodeURIComponent(lectureId)}`, {credentials:'same-origin'});
        if (!res.ok) throw new Error(`Не удалось загрузить лекцию (${res.status})`);
        const l = await res.json();

        titleEl.textContent = l.title || `Лекция #${l.id}`;
        badgeId.classList.remove('d-none');
        badgeId.textContent = `ID: ${l.id ?? '—'}`;

        descEl.innerHTML = l.description ? safeHtml(l.description).replaceAll('\n','<br/>') : '—';
        // content может быть HTML — показываем как есть (если храните HTML);
        // если у тебя plain-text — используй safeHtml(l.content)
        contentEl.innerHTML = l.content || '—';
      }

      async function loadTests() {
        const res = await fetch(`/api/v1/public/lectures/${encodeURIComponent(lectureId)}/tests`, {credentials:'same-origin'});
        if (res.status === 401) {
          testsBox.innerHTML = `<div class="alert alert-warning mb-0">Войдите, чтобы увидеть доступные тесты.</div>`;
          return;
        }
        if (!res.ok) throw new Error(`Не удалось загрузить тесты (${res.status})`);
        const tests = await res.json();

        if (!tests.length) {
          testsBox.innerHTML = '<span class="text-muted">Нет доступных тестов.</span>';
          return;
        }
        const ul = document.createElement('ul');
        ul.className = 'list-group';
        tests.forEach(t => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';

          const left = document.createElement('div');
          left.innerHTML = `<div><strong>${safeHtml(t.description || 'Тест')}</strong></div>
                            <div class="text-muted small">Вопросов: ${t.questionCount ?? '—'}</div>`;

          const btn = document.createElement('a');
          btn.className = 'btn btn-primary btn-sm';
          btn.textContent = 'Перейти к тесту';
          // используем твой существующий роут MVC:
          btn.href = `/kubstuTest/test/${encodeURIComponent(t.id)}`;

          li.appendChild(left);
          li.appendChild(btn);
          ul.appendChild(li);
        });
        testsBox.innerHTML = '';
        testsBox.appendChild(ul);
      }

      (async function boot() {
        try {
          await loadLecture();
          await loadTests();
        } catch (e) {
          errBox.textContent = e?.message || 'Ошибка загрузки';
          errBox.classList.remove('d-none');
        }
      })();
    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
